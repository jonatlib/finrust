services:
  # ----------------------------------------------------
  # 1. Backend Service
  # ----------------------------------------------------
  backend:
    image: xlikos/finrust:backend
    restart: always

    # Same command as dev to ensure migrations run
    command: >
      /app/finrust migrate-and-serve 
      --database-url sqlite:///app/data/finrust.db?mode=rwc 
      --bind-address 0.0.0.0:8080

    environment:
      - DATABASE_URL=sqlite:///app/data/finrust.db?mode=rwc
      - BIND_ADDRESS=0.0.0.0:8080
      - RUST_LOG=info

    ports:
      - "8080:8080"
    volumes:
      # Ensure this directory exists on your production server
      - ./data:/app/data

  # ----------------------------------------------------
  # 2. Frontend Service
  # ----------------------------------------------------
  frontend:
    image: xlikos/finrust:frontend
    restart: always
    ports:
      - "8081:80"
    depends_on:
      - backend

    # Production Environment Variables
    # Change these to match your actual Production Domain/IP
    environment:
      - API_HOST=my-production-server.com  # <--- CHANGE THIS
      - API_PORT=8080
      - API_PATH=/api/v1
      - API_USE_HTTPS=false # Set to true if you put SSL in front

    command: >
      sh -c "echo 'window.ENV = {
        \"API_HOST\": \"'$$API_HOST'\",
        \"API_PORT\": \"'$$API_PORT'\",
        \"API_PATH\": \"'$$API_PATH'\",
        \"API_USE_HTTPS\": \"'$$API_USE_HTTPS'\"
      };' > /usr/share/nginx/html/config.js && nginx -g 'daemon off;'"
