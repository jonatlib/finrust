services:
  # ----------------------------------------------------
  # 1. Backend Service (Rust)
  # ----------------------------------------------------
  backend:
    build:
      context: .
      dockerfile: Dockerfile
      target: backend
    restart: unless-stopped

    # ------------------------------------------------------------------
    # COMMAND: Run migrations and start the server
    # ------------------------------------------------------------------
    # Normal usage (local):
    # cargo run --release -- serve --database-url sqlite://./finrust.sqlite
    #
    # Docker usage (binary):
    command: >
      /app/finrust migrate-and-serve 
      --database-url sqlite:///app/data/finrust.db?mode=rwc 
      --bind-address 0.0.0.0:8080

    environment:
      # We set these for safety, though the command flags above take precedence.
      # Note: The CLI uses BIND_ADDRESS, not PORT.
      - DATABASE_URL=sqlite:///app/data/finrust.db?mode=rwc
      - BIND_ADDRESS=0.0.0.0:8080
      - RUST_LOG=info

    ports:
      - "8080:8080"
    volumes:
      # Bind mount the local ./data folder to the container
      - ./data:/app/data

  # ----------------------------------------------------
  # 2. Frontend Service (Nginx)
  # ----------------------------------------------------
  frontend:
    build:
      context: .
      dockerfile: Dockerfile
      target: frontend
    restart: unless-stopped
    ports:
      - "8081:80"
    environment:
      # Frontend API configuration
      # These variables configure where the frontend sends API requests
      - API_HOST=127.0.0.1
      - API_PORT=8080
      - API_PATH=/api/v1
      - API_USE_HTTPS=false
    command: >
      sh -c "echo 'window.ENV = {
        \"API_HOST\": \"'$$API_HOST'\",
        \"API_PORT\": \"'$$API_PORT'\",
        \"API_PATH\": \"'$$API_PATH'\",
        \"API_USE_HTTPS\": \"'$$API_USE_HTTPS'\"
      };' > /usr/share/nginx/html/config.js && nginx -g 'daemon off;'"
