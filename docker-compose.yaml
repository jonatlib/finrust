services:
  # ----------------------------------------------------
  # 1. Backend Service (Rust)
  # ----------------------------------------------------
  backend:
    # DEFINES THE IMAGE NAME FOR PUSHING
    image: xlikos/finrust:backend
    # FORCE LINUX/AMD64 BUILD
    platform: linux/amd64
    build:
      context: .
      dockerfile: Dockerfile
      target: backend
    restart: unless-stopped

    # Run migrations and start the server
    command: >
      /app/finrust migrate-and-serve 
      --database-url sqlite:///app/data/finrust.db?mode=rwc 
      --bind-address 0.0.0.0:8080

    environment:
      - DATABASE_URL=sqlite:///app/data/finrust.db?mode=rwc
      - BIND_ADDRESS=0.0.0.0:8080
      - RUST_LOG=info

    ports:
      - "8080:8080"
    volumes:
      - ./data:/app/data

  # ----------------------------------------------------
  # 2. Frontend Service (Nginx)
  # ----------------------------------------------------
  frontend:
    # DEFINES THE IMAGE NAME FOR PUSHING
    image: xlikos/finrust:frontend
    # FORCE LINUX/AMD64 BUILD
    platform: linux/amd64
    build:
      context: .
      dockerfile: Dockerfile
      target: frontend
    restart: unless-stopped
    ports:
      - "8081:80"

    depends_on:
      - backend

    environment:
      # Frontend API configuration
      - API_HOST=127.0.0.1
      - API_PORT=8080
      - API_PATH=/api/v1
      - API_USE_HTTPS=false

    # Inject environment variables into config.js at runtime, then start Nginx
    # Note: '$$' is used to escape the variable so Docker Compose doesn't
    # interpolate it, allowing the container's shell to expand it.
    command: >
      sh -c "echo 'window.ENV = {
        \"API_HOST\": \"'$$API_HOST'\",
        \"API_PORT\": \"'$$API_PORT'\",
        \"API_PATH\": \"'$$API_PATH'\",
        \"API_USE_HTTPS\": \"'$$API_USE_HTTPS'\"
      };' > /usr/share/nginx/html/config.js && nginx -g 'daemon off;'"
